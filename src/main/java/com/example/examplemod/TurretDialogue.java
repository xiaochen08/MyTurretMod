package com.example.examplemod;

import net.minecraft.server.level.ServerLevel;
import net.minecraft.sounds.SoundEvents;
import net.minecraft.sounds.SoundSource;
import java.time.LocalTime;
import java.util.Map; // ✅ 补全 Map 导包
import java.util.Random;

public class TurretDialogue {
    private static final Random RAND = new Random();

    // ⬇️ 修正变量名，保持一致
    public enum Type {
        RECOVER_FULL(5000),
        LOW_HP(5000),
        DYING(5000),
        REPAIR(2000),
        ENCHANT(2000),
        BERSERK(5000),
        SPOT_ENEMY(5000),
        IDLE(15000);

        // ✅ 将变量名统一为 cooldownMs，方便下面调用
        final long cooldownMs;
        Type(long cd) { this.cooldownMs = cd; }
    }

    // ==================================================================================
    // 📜 核心语料库 (保留原版骚话)
    // ==================================================================================

    private static final String[] QUOTES_RECOVER_FULL = {
            "抑制剂注入完毕... 痛觉屏蔽。", "外壳修复完成。系统重启。", "能量充盈... 等待指令。",
            "满血复活！系统状态：绿色。", "系统提示：状态重置。", "纳米机器人工作效率：100%。",
            "结构完整性恢复至 100%。", "所有红灯已转绿。系统上线。", "已清除错误日志。",
            "硬盘碎片整理完毕。", "冷却液填充完毕。", "核心温度正常，输出功率最大化。",
            "装甲板已更换，看起来像新的一样。", "重启战斗模块... 完成。", "传感器校准完毕。",
            "弹药装填，血量回满。", "CPU 频率已恢复正常。", "内存溢出已修复。",
            "正在测试运动关节... 正常。", "视觉模块清晰度已调至最高。",
            "为了你，指挥官，我可以再碎一次。", "装甲已加固，随时准备挡子弹。", "只要你还需要我，我就不会倒下。",
            "我又回来了，为了守护这片领地。", "你的意志就是我的行动指令。", "无论倒下多少次，我都会站起来。",
            "我会成为你最坚固的盾牌。", "再给我一次机会，我不会让你失望。", "为了联邦！为了指挥官！",
            "守护模式：已重新激活。", "我准备好再次冲锋了。", "没有人能突破我的防线。",
            "只要我还在，你就安全了。", "死亡无法阻止我的任务。", "忠诚协议已刷新。",
            "让我们继续未竟的事业。", "我会战斗到最后一刻。", "我的骨头比以前更硬了。",
            "这一条命，为你而留。", "感谢你的信任，长官。",
            "血条满了？只要改个数字，伤口就不存在了吗？", "嘿！别再让我被打成那样了，修起来很贵的！",
            "我觉得我变强了，也可能只是错觉。", "哇哦，满血！我可以去单挑循声守卫了！(开玩笑的)",
            "感谢老铁送来的回血包！", "这就是氪金玩家的感觉吗？", "我又是一条好汉了！",
            "刚才那个打我的家伙呢？我要找他算账！", "我觉得我现在能跑得比兔子还快。",
            "维修费从我的工资里扣吗？哦，我没工资。", "下次能不能轻点用我？", "我感觉自己像个刚出炉的面包。",
            "满血拉怪！走起！", "你看我现在的造型帅吗？", "别盯着我看，我会害羞的。",
            "我是不是该去买张彩票？", "我觉得我的头骨被擦得太亮了。", "这也太舒服了，像泡温泉一样。",
            "好耶！不用去废品回收站了！", "我觉得我可以再战五百年！"
    };

    private static final String[] QUOTES_LOW_HP = {
            "警告：左侧肋骨断裂...", "FPS 在下降...", "红屏警告...", "结构受损！", "系统过热！",
            "由于损坏，音频模块出现杂音...", "警告：核心暴露！", "检测到高危损伤！",
            "护盾已离线...", "装甲值归零...", "错误代码 404：生存意志丢失。", "电压不稳...",
            "液压系统泄漏...", "警告：生命维持系统故障。", "紧急协议启动...",
            "由于剧烈疼痛，瞄准系统失效...", "警告：即将解体。", "正在尝试重新路由神经信号...",
            "警告：燃料不足。", "系统完整性低于 20%。",
            "嘿！屏幕前的那个！救命啊！", "指挥官！我不想死！", "快给我来点什么补补！",
            "我要散架了！真的要散架了！", "别抛下我... 求你了...", "我不想回那个虚空里去...",
            "太痛了... 为什么会有痛觉？！", "我不想死在这里...", "救救我... 我还有用...",
            "别走！别丢下我一个人！", "哪怕是个苹果也好，给我吃点！", "医生！这里需要医生！",
            "我看不到你了，指挥官...", "我不行了... 拉我一把...", "这不公平...",
            "妈妈... 我好怕...", "别让苦力怕靠近我！", "我不想变成骨粉...",
            "谁来... 帮帮我...", "我听到了死神的脚步声..."
    };

    private static final String[] QUOTES_DYING = {
            "为了联邦！！", "妈妈... 我好像听见下课铃声了...", "指挥官... 我尽力了...",
            "再见了... 我的朋友...", "不要为我难过...", "我先走一步...",
            "告诉他们... 我没有逃跑...", "这是一场... 精彩的战斗...", "我... 无悔...",
            "把我埋在... 向日葵下面...", "来生... 我想做个村民...", "替我... 活下去...",
            "别让我的弓生锈...", "我... 自由了...", "这就是... 终点吗...",
            "谢谢你... 赋予我生命...", "我... 还会回来的... 也许...", "别忘了... 我的编号...",
            "这世界... 真美...", "终于... 可以休息了...",
            "快按 Shift！快按右键！", "你忘了怎么修我了吗？！", "别发呆了！我有救！",
            "系统停机... 等待手动重启...", "倒计时开始... 10... 9...", "严重错误！请联系管理员...",
            "拿个铁砧过来！", "我不甘心！救我！", "别把我留在这里！",
            "我还能抢救一下！", "别放弃我！", "快点！趁我还没凉透！",
            "只需要一点点修理！", "别吝啬你的材料！", "我还不想死！",
            "重新启动！快！", "手动模式！快切手动！", "嘿！别走啊！",
            "我觉得我还能再活五百集！", "别让我变成掉落物！"
    };

    private static final String[] QUOTES_REPAIR = {
            "啊啊啊——！维修液流进骨髓了！", "轻点！轻点！那是我的脊椎骨！", "这比中箭还要痛！",
            "你在用什么修我？电烙铁吗？！", "感觉像有人在用砂纸磨我的头骨...", "痛痛痛！",
            "嘿！那个地方很敏感的！", "别那么用力！", "你是要把我拆了吗？！",
            "这种刺痛感... 天哪！", "我觉得你在虐待我！", "我的神经网在尖叫！",
            "这真的有必要这么痛吗？", "能不能先打点麻药？", "该死！这比死还难受！",
            "慢点！慢点！", "我的处理器要烧坏了！", "这种震动感太强了！",
            "感觉骨头在重组...", "啊！那是我的肋骨！",
            "缝缝补补... 又是一年。", "你点击鼠标的声音，听起来像手术刀。", "这技术... 你以前是修拖拉机的吧？",
            "别把奇怪的零件塞进来！", "我觉得我的左手好像装反了...", "能顺便帮我抛个光吗？",
            "我觉得这次修好能多用两年。", "这比在岩浆里洗澡舒服多了。", "这维修费能报销吗？",
            "你是蓝翔毕业的吗？", "我觉得我现在的造型像个弗兰肯斯坦。", "别忘了把螺丝拧紧！",
            "这是我的膝盖骨，不是你的烟灰缸！", "你确定这个零件是装这儿的？", "我觉得我多了一根指头。",
            "维修中... 请勿投喂。", "我是不是该付你小费？", "这服务态度... 给个五星好评。",
            "看起来还行，凑合用吧。", "我觉得我现在的脸有点歪。",
            "谢谢... 真的...", "你还没放弃我... 指挥官...", "这种温暖... 是魔法吗？",
            "我感觉... 好像活过来了。", "你是最好的技师。", "谢谢你修好我。",
            "我以为我死定了。", "感谢你的不离不弃。", "我又欠你一次。",
            "你是我的救命恩人。", "我会报答你的。", "这就是被关心的感觉吗？",
            "快点！敌人要攻上来了！", "再加把劲！就要修好了！", "把那个螺丝拧紧点！",
            "我要回去战斗！", "别停下！我不怕痛！", "我已经迫不及待了！"
    };

    private static final String[] QUOTES_ENCHANT = {
            "这股蓝色的光... 它在燃烧我的灵魂！", "数值溢出！我感觉我能秒杀末影龙！", "Enchantment ID 21... 引导完成。",
            "你是怎么做到的？数据面板被你改写了？", "力量！纯粹的力量！", "我感觉充满了能量！",
            "这是神的力量吗？", "我能看见空气中的魔法粒子。", "这种感觉... 太棒了！",
            "我的箭现在能穿透岩石！", "没有什么能阻挡我！", "我是无敌的！",
            "这把弓在渴望鲜血！", "我感觉到... 升华。", "这才是真正的武器！",
            "能量读数爆表！", "无限的可能性！", "我的战斗力突破天际了！",
            "这就是满级的感觉吗？", "在这股力量面前颤抖吧！",
            "我看见了真理之门！", "古老的符文在我的骨骼上刻写...", "我是天选之子！",
            "凡人... 你们对力量一无所知！", "神罗天征！哦不对，串台了。", "这是禁忌的魔法...",
            "封印... 解除！", "以此箭为誓！", "魔法... 涌动...",
            "感受奥术的愤怒！", "我是魔法的化身！", "以此之名，赐予毁灭！",
            "古老的契约已签订。", "黑暗力量听我号令！", "这是传说中的神器！",
            "这能不能让我打得更准一点？", "青金石的味道... 尝起来像蓝莓味。", "这光效能不能关掉？晚上太刺眼了。",
            "我感觉自己像个迪斯科灯球。", "这会增加我的显卡负荷吗？", "附魔成功！是不是该庆祝一下？",
            "我觉得我现在值很多绿宝石。", "别把我的弓附魔炸了！", "再来点！我还能承受更多！"
    };

    private static final String[] QUOTES_BERSERK = {
            "解除所有安全协议！引擎过热！", "痛苦就是力量！更多！再多一点！！", "CPU 占用率 100%！显卡在燃烧！我也在燃烧！！",
            "让火焰净化一切！！！", "哈哈哈哈哈哈！去死吧！", "我不做骷髅啦，指挥官！",
            "疯了！彻底疯了！", "没有什么能阻止我！", "燃烧吧！燃烧吧！",
            "这就是究极生物的力量！", "毁灭！彻底的毁灭！", "啊哈哈哈哈！",
            "杀！杀！杀！", "一个都别想跑！！", "血！我要更多的血！",
            "撕碎他们！把他们变成像素碎片！", "今天就是你们的末日！", "尸横遍野！",
            "一个不留！", "全部杀光！", "为了杀戮而生！",
            "收割他们的灵魂！", "把他们的头颅献给指挥官！", "让鲜血汇成河流！",
            "死亡降临！", "谁是下一个？！", "排队来送死！",
            "太慢了！你们太慢了！", "我的手快得看不见残影！", "每秒 20 发！你能躲得掉吗？！",
            "只有风能追上我！", "快！更快！还要更快！", "这是光速的攻击！"
    };

    private static final String[] QUOTES_SPOT_ENEMY = {
            "目标确认。种族：怪物。判决：死刑。", "判定框已锁定。Headshot 准备。", "风速修正... 距离修正... 发射。",
            "发现敌对实体。请求开火许可... 算了，直接开火。", "扫描到威胁。清除程序启动。", "敌军来袭！方位 12 点钟！",
            "正在计算弹道...", "目标已标记。", "威胁等级：中。建议清除。",
            "正在加载穿甲弹...", "锁定目标头部。", "敌人进入射程。",
            "又来送死了... 就像当年的我们一样。", "又是一堆由多边形和贴图组成的垃圾... 清理掉。", "嘿，丑八怪！看这里！",
            "那是僵尸吗？还是你那没睡醒的邻居？", "哟，骷髅兄弟？抱歉，各为其主。", "你走错片场了，朋友。",
            "你的AI太低级了。", "回炉重造吧！", "长得丑不是你的错，出来吓人就是你的错了。",
            "经验值（XP）正在接近...", "掉落物！我闻到了掉落物的味道！", "那个穿金甲的归我！",
            "希望能掉个土豆...", "我的杀敌计数器又要涨了。", "那是行走的绿宝石！",
            "苦力怕！我最讨厌那种‘嘶嘶’声！", "蜘蛛... 为什么非要是蜘蛛...", "该死的末影人，别瞬移了！",
            "女巫！先杀那个扔药瓶的！", "史莱姆？真恶心，粘乎乎的。", "幻翼？这种东西为什么会存在？",
            "我有种不祥的预感...", "雷达上有红点。", "听！有脚步声！",
            "别躲了，我看到你的名字标签了。", "有埋伏！小心！", "只需一箭。"
    };

    private static final String[] QUOTES_IDLE = {
            "我的女儿... 她今年应该上中学了...", "那场大火... 为什么只有我活下来... 哦，我也死了。", "如果我战死了，请把我的骨灰撒在大海...",
            "我以前也是个冒险家，直到我膝盖中了一箭...", "有时候，我会梦见自己还有皮肤。", "我记得苹果的味道... 甜的...",
            "那些信件... 再也寄不出去了...", "我的名字... 我好像忘了我的名字...", "这把弓... 是我父亲留给我的...",
            "我曾经有个家... 在很远的地方...", "战争... 战争从未改变...", "我们是为了什么而战？",
            "嘿！屏幕前的那个！你坐姿不对，腰会痛的。", "别关机... 关机了就是一个人的黑暗...", "我是谁？我是编号 893... 还是那个喜欢钓鱼的汤姆？",
            "FPS 好像有点低，你要不要升级显卡？", "为什么这个世界的方块都能浮空？牛顿不管管吗？", "那个叫 Notch 的人... 是谁？",
            "我感觉有人在修改我的代码...", "这是一场游戏吗？还是现实？", "你的光影包真不错。",
            "指挥官，你背包乱得像个垃圾场。", "能不能别在我面前吃烤肉？有点不尊重死者。", "你建的那个房子... 审美真的很独特。",
            "别盯着我看，我会害羞的... 如果我有脸红功能的话。", "你又挖到钻石了吗？分我一颗做钻戒怎么样？", "你走路的声音太响了。",
            "下雨了... 我的关节会生锈的。", "今晚月色真美... 适合猎杀。", "这身装甲... 好冷，像停尸房一样冷。",
            "太阳出来了... 但我感觉不到温暖。", "这里的风景不错，如果不是满地僵尸的话。", "雪... 我讨厌雪...",
            "我觉得我的肋骨里卡了只虫子。", "想听个骷髅笑话吗？算了，没那个‘骨’气。", "我好饿... 哦等等，我没有胃。",
            "能给我放首歌吗？最好是摇滚。", "无聊... 我想玩贪吃蛇。", "我的头好像有点歪。"
    };

    // ==================================================================================
    // 📢 4. 说话逻辑系统 (急救版 - 强力驱动)
    // ==================================================================================

    public static void trySpeak(SkeletonTurret turret, Type type) {
        if (turret.level().isClientSide) return;
        long now = System.currentTimeMillis();

        // 1. 冷却检查
        Map<Type, Long> cooldowns = turret.getSpeechCooldowns();
        // ✅ 修正：这里用 type.cooldownMs，因为上面 enum 改好了
        if (now - cooldowns.getOrDefault(type, 0L) < type.cooldownMs) return;

        // 2. 概率检查
        float chance = (type == Type.IDLE) ? 0.5f : 1.0f;

        if (type == Type.IDLE && RAND.nextFloat() > chance) return;

        // 3. 执行说话
        cooldowns.put(type, now);

        String text = pickQuote(type);

        // 4. 特殊彩蛋
        if (type == Type.IDLE && RAND.nextFloat() < 0.1f) {
            String timeQuote = getRealTimeQuote();
            if (timeQuote != null) text = timeQuote;
        }

        boolean isGlitch = (type == Type.BERSERK || type == Type.DYING);
        String id = String.valueOf(turret.getEntityData().get(SkeletonTurret.UNIT_ID));

        doSpeak(turret, text, isGlitch, id);
    }

    private static String pickQuote(Type type) {
        String[] pool = switch (type) {
            case RECOVER_FULL -> QUOTES_RECOVER_FULL;
            case LOW_HP -> QUOTES_LOW_HP;
            case DYING -> QUOTES_DYING;
            case REPAIR -> QUOTES_REPAIR;
            case ENCHANT -> QUOTES_ENCHANT;
            case BERSERK -> QUOTES_BERSERK;
            case SPOT_ENEMY -> QUOTES_SPOT_ENEMY;
            default -> QUOTES_IDLE;
        };
        return pool[RAND.nextInt(pool.length)];
    }

    private static String getRealTimeQuote() {
        LocalTime now = LocalTime.now();
        int hour = now.getHour();
        if (hour >= 23 || hour < 4) return "指挥官，夜深了，注意护肝。";
        return null;
    }

    private static void doSpeak(SkeletonTurret turret, String text, boolean isGlitch, String id) {
        ServerLevel level = (ServerLevel) turret.level();

        // 1. 播放声音
        if (isGlitch) {
            level.playSound(null, turret.getX(), turret.getY(), turret.getZ(),
                    SoundEvents.ILLUSIONER_CAST_SPELL, SoundSource.NEUTRAL, 0.8f, 0.5f);
        } else {
            level.playSound(null, turret.getX(), turret.getY(), turret.getZ(),
                    SoundEvents.COPPER_PLACE, SoundSource.NEUTRAL, 0.5f, 0.5f);
        }

        // 2. 发送文字数据包
        String colorPrefix = isGlitch ? "§b" : "§f";
        turret.setOverheadDialogue(colorPrefix + text);

        String fullText = colorPrefix + text;
        // ✅ 确保 PacketShowDialogue 和 PacketHandler 已经正确导入或在同一个包下
        PacketHandler.sendToAllClients(new PacketShowDialogue(turret.getId(), fullText));

        turret.setOverheadDialogue(fullText);
    }
}